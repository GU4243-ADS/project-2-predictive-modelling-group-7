---
title: "R Notebook"
output: html_notebook
---

```{r}
if(!require("EBImage")){
  source("https://bioconductor.org/biocLite.R")
  biocLite("EBImage")
}

```

```{r}
experiment_dir <- "../data/" # This will be modified for different data sets.
img_train_dir  <- paste(experiment_dir, "train/", sep = "")
img_test_dir <- paste(experiment_dir, "test/", sep = "")

```

```{r}
library(tidyverse)
label <- read_csv(paste('../data/train_label.txt', sep=''),
                   col_names = c('label'))

label <-ifelse(label$label == "dog", 1, 0) # binary classification, dog = 1, cat = 0. 

```

```{r}
library(gbm)
hog <- read.csv("../output/hog_features.csv")

# sift <- read.csv("../pets/train-features")

hog$label <- label

# Splitting the dataset into the Training set and Test set
# install.packages('caTools')
library(caTools)
set.seed(123)
split = sample.split(hog$label, SplitRatio = 0.8)
training_set = subset(hog, split == TRUE)
test_set = subset(hog, split == FALSE)

library(gbm)
tm_train<- system.time(bst <- gbm(data = as.matrix(training_set[-55]))

# Predicting the Test set results
tm_test <- system.time(y_pred <- predict(bst, newdata = as.matrix(test_set[-55])))
y_pred <- (y_pred >= 0.5)

```

```{r}
# Making the Confusion Matrix
cm = table(test_set[, 55], y_pred)

# Applying k-Fold Cross Validation
# install.packages('caret')
library(caret)
folds = createFolds(training_set$label, k = 10)
cv = lapply(folds, function(x) {
  training_fold = training_set[-x, ]
  test_fold = training_set[x, ]
  bst = xgboost(data = as.matrix(training_fold[-55]), 
               label = training_fold$label,
               max.depth = 4,
               eta = .5,
               nround = 20,
               nthread = 2, objective = "binary:logistic")
  y_pred = predict(bst, newdata = as.matrix(test_fold[-55]))
  y_pred = (y_pred >= 0.5)
  cm = table(test_fold[, 55], y_pred)
  accuracy = (cm[1,1] + cm[2,2]) / (cm[1,1] + cm[2,2] + cm[1,2] + cm[2,1])
  return(accuracy)
})
accuracy = mean(as.numeric(cv))
```
```{r}
accuracy
```


```{r}
cat("Time for constructing training features=", tm_feature_train[1], "s \n")
cat("Time for training model=", tm_train[1], "s \n")
cat("Time for making prediction=", tm_test[1], "s \n")

```

